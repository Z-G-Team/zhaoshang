(function(n){var i=n.member={},t={orderState_All:"",orderState_Pending:"",orderState_Processing:"",orderState_Complete:"",returnReason_Quality:"",FreebiesVerifyUrl:"",orderSn:"",year:"",returnCanSubmit:!1,errorClass:$.validator.defaults.errorClass,returnErrorMsg:""};jQuery.extend(n.member,{ListInit:function(n){t=$.extend({},t,n||{});$(".pager a").removeClass("ui-link");t.year=$("tr[data-order-year]:first-child").attr("data-order-year");$(".writeback-return").on("click",function(){Mobile.member.setWriteBackReturnNo($(this).attr("data-sn"))});$(".order-state").on("vclick",function(){if($(this).find("[class='off']").length>0){$target=$(this).find("[class='off']");$(".order-state .on").removeClass("on").addClass("off");$target.removeClass("off").addClass("on");var n=$target.attr("data-order-state");n==t.orderState_All?$("tr[data-order-state]").removeClass("hidden"):($("tr[data-order-state="+n+"]").removeClass("hidden"),$("tr[data-order-state]").not("tr[data-order-state="+n+"]").addClass("hidden"));$("tr[data-order-state]:visible").length===0?$("tr.order-list-empty").removeClass("hidden"):$("tr.order-list-empty").addClass("hidden")}})},historyAddressDel:function(n,t){var i=$(n),r=i.parents("tr").attr("addressid");$.ajax({type:"POST",url:t,data:{addressID:r},dataType:"json",beforeSend:function(){$.mobile.loading("show",{text:"处理中...",textonly:!0,textVisible:!0,theme:"b"})},complete:function(){$.mobile.loading("hide")},success:function(n){var t,r;n&&n.Success?(i.parents("tr").remove(),t=$("#list-addr-"+n.Data),t.length>0&&(r=t.text(),t.html('<span class="mred">【默认】<\/span>'+r),$(".box-line-list tbody tr:first").before(t.parents("tr")))):Mobile.common.showAlertMessage("删除失败，请稍后在重新尝试")}})},defaultAddress:function(n,t,i){var r=$(n),u=r.parents("tr").attr("addressid");$.ajax({type:"POST",url:t,data:{addressID:u},dataType:"json",beforeSend:function(){$.mobile.loading("show",{text:"处理中...",textonly:!0,textVisible:!0,theme:"b"})},complete:function(){$.mobile.loading("hide")},success:function(n){n&&n.Success?location.href=i:Mobile.common.showAlertMessage("默认失败，请稍后在重新尝试")}})},returnInit:function(n){t=$.extend({},t,n||{});$("#return-submit.on").on("click",function(){Mobile.member.returnCheck()});$("#return-submit.off").on("click",function(){location.href=t.OrderIndex});$("#orderForm").submit(function(){return t.returnCanSubmit?($("#return-submit").text("处理中...").attr("disabled","disabled"),t.returnCanSubmit=!1,!0):!1});$(".prod_confirm").on("change",function(){$quantity=$(this).parents("tr").find("select.quantity");$(this).is(":checked")&&$quantity.val()==""?($quantity.val("1").selectmenu("refresh"),$quantity.change()):$(this).is(":checked")||($quantity.val("").selectmenu("refresh"),$quantity.change())});$(".quantity").on("change",function(){Mobile.member.returnCaculate($(this))});$(".ddl1").on("change",function(){$(this).val()==t.returnReason_Quality?$(this).parents("tr").find(".reason-text-box").show():$(this).parents("tr").find(".reason-text-box").hide()});$("input , select").on("blur",function(){Mobile.member.checkReturnElement($(this),"")});$(".apply-text a").on("touchstart",function(){Mobile.common.CreatePanel($(this),"policy")})},returnValidate:function(){var n,i,r,u,f;return $(".prod_confirm:checked").size()==0?(Mobile.common.showAlertMessage("请勾选要退货的商品"),!1):(n=!0,i=!0,$(".prod_confirm:checked").each(function(){var r=$("[name="+$(this).attr("name").replace("_Confirm","_Quantity")+"]"),t;Mobile.member.checkReturnElement(r,"0")||(n=!1);t=$("[name="+$(this).attr("name").replace("_Confirm","_Reason")+"]");Mobile.member.checkReturnElement(t,"0")||(i=!1)}),r=!0,u=!0,$(".ddl1").each(function(){if($(this).val()==t.returnReason_Quality){var n=$("input[name="+$(this).attr("name")+"1]");Mobile.member.checkReturnElement(n,"1")?Mobile.member.checkReturnElement(n,"2")||(u=!1):r=!1}}),n||(t.returnErrorMsg+="请选择退货数量<br/>"),i||(t.returnErrorMsg+="请选择退货原因<br/>"),r||(t.returnErrorMsg+="请输入质量问题描述<br/>"),u||(t.returnErrorMsg+="质量问题描述请勿输入超过50字<br/>"),Mobile.member.checkReturnElement($(".chk-confirm"),"0")||(t.returnErrorMsg+="请阅读并接受退货政策<br/>"),t.returnErrorMsg!="")?(f=$(".error:first"),f.focus(),$(document).scrollTop(f.offset().top-$(".empty-header").outerHeight()),Mobile.common.showAlertMessage(t.returnErrorMsg),t.returnErrorMsg="",!1):!0},returnCaculate:function(n){var i=0;$tr=n.parents("tr");$check=$tr.find(".prod_confirm");var t=$tr.find("select.quantity").val(),e=$check.attr("purchase"),o=parseInt($check.attr("o-amount")),r=parseInt($check.attr("a-amount")),u=parseFloat($check.attr("o-price")),f=parseFloat($check.attr("a-price"));t>0&&(e=="True"?t>=r?(i=f*r,t-=r,i+=u*t):i=f*t:i=t*u);$tr.prev(".tr-prod").find(".prod-price").text(i)},returnCheck:function(){if(Mobile.member.returnValidate()){var i=$('.apply-info input[type="checkbox"]:checked'),n="";i.each(function(t){var u=$(this).attr("sn"),r=0;$select=$(this).parents("tr").find("select.quantity");r=$select.size()>0?$select.val():$(this).parents("tr").find(".quantity").val();n+=t==0?"{"+u+":"+r:","+u+":"+r;t==i.length-1&&(n+="}")});$.ajax({type:"POST",url:t.FreebiesVerifyUrl,data:{orderSn:t.orderSn,returnProducts:n},dataType:"json",success:function(n){n.Success?(t.returnCanSubmit=!0,$("#popupConfirmReturn").html()===undefined?$("#orderForm").submit():$("#popupConfirmReturn").popup("open",{positionTo:"window"})):(t.returnCanSubmit=!1,$("#return-submit").removeAttr("style disabled"),Mobile.common.showAlertMessage(n.Message))}})}},checkReturnElement:function(n,i){var r=n.attr("class");if(r=="quantity"){if(n.val()=="")return i!=""&&n.parent().addClass(t.errorClass),!1;n.parent().removeClass(t.errorClass)}else if(r=="ddl1"){if(n.val()==""||n.val().length>30)return i!=""&&n.parent().addClass(t.errorClass),!1;n.parent().removeClass(t.errorClass)}else if(r=="reason-text"){if(i=="1"||i==""){if(n.val()=="")return i!=""&&n.parent().addClass(t.errorClass),!1;n.parent().removeClass(t.errorClass)}else if(i=="2"||i==""){if(n.val().length>50)return i!=""&&n.parent().addClass(t.errorClass),!1;n.parent().removeClass(t.errorClass)}}else if(r=="chk-confirm")if(n.is(":checked"))n.prev("label").removeClass(t.errorClass);else return n.prev("label").addClass(t.errorClass),!1;return!0},canBeRejected:function(n,t){$.ajax({type:"POST",url:t,data:{sn:n.attr("data-sn")},dataType:"json",success:function(n){n.Success?location.href=n.Data:n.Data?location.href=n.Data:($("#popupReject .popup-map-content").html(n.Message),$("#popupReject").popup("open"),setTimeout(function(){$("#popupReject").popup("close")},2e3))}})},setWriteBackReturnNo:function(n){$.post(t.GetWriteBackReturnNo,{sn:n},function(n){if(n.Success){var i=$("#popupWriteBackReturn"),f=i.find("#return-co"),u=i.find("#return-no"),e=i.find("#enable-return-po"),s=i.find("#return-po"),h=n.Data["退貨單ID"],r=$.trim(n.Data["物流公司"]),o=$.trim(n.Data["退貨單號"]),c=n.Data["退貨單狀態"],l=n.Data["運費到付"]==="True",a=n.Data["允許郵資"]==="True",v=$.trim(n.Data["郵資"]);u.val(o);s.val(v);i.find("#return-id").val(h);i.find(".qrcode").length>0&&wx.config({debug:!1,appId:n.Data.appID,timestamp:n.Data.timeStamp,nonceStr:n.Data.nonceStr,signature:n.Data.sign,jsApiList:["scanQRCode"]});parseInt(c)>=parseInt(t.returnState_PackageGet)?(f.val(r).addClass("not-edit").removeClass("can-edit").attr("disabled","disabled"),u.addClass("not-edit").removeClass("can-edit").attr("disabled","disabled"),i.find("#d-co-select").val(r),i.find(".qrcode, #co-select-box, .sent").hide(),i.find("#co-input-box").show()):l?(f.val(r).addClass("not-edit").removeClass("can-edit").attr("disabled","disabled"),u.addClass("can-edit").removeClass("not-edit").removeAttr("disabled"),i.find("#d-co-select").val(r),i.find("#co-select-box").hide(),i.find(".qrcode, #co-input-box, .sent").show()):(o===""?i.find(".sent").val("提交"):i.find(".sent").val("修改"),i.find("#d-co-select option[value='"+r+"']").length>0?(i.find("#d-co-select").val(r).selectmenu("refresh"),i.find("#co-input-box").hide()):(i.find("#d-co-select").val("其他").selectmenu("refresh"),f.val(r),i.find("#co-input-box").show()),i.find(".qrcode, #co-select-box, .sent").show(),f.removeAttr("disabled").addClass("can-edit").removeClass("not-edit"),u.removeAttr("disabled").addClass("can-edit").removeClass("not-edit"));a?e.show():e.hide();i.popup("open");i.animate({height:i.find("#PopupContent").outerHeight(!0)+"px"},0);r===""&&u.focus()}else Mobile.common.showAlertMessage(n.Message)})}})})(Mobile)