$(function(){$.order={init:function(n){setting=$.extend({},setting,n||{});$(".order-history").on("click",$.order.getOrderHistory);$(".return-tracking").on("click",$.order.getReturnTracking);$(".order-cancel").on("click",function(){return $.fancybox({href:$(this).attr("href")},{width:550,height:340,type:"iframe",border:"5px solid rgba(40, 40, 40, 0.7)"}),!1});$(".writeback-return").on("click",function(){return $.fancybox({href:$(this).attr("href")},{width:350,height:420,type:"iframe",border:"5px solid rgba(40, 40, 40, 0.7)"}),!1})},getOrderHistory:function(){var t=$(this),n=t.parents("tr").next(".history-detail"),i;return n.find(".h-list:first").length>0?(i=n.hasClass("on"),i?n.hide().removeClass("on"):($(".history-detail.on").hide().removeClass("on"),$(".return-detail.on").hide().removeClass("on"),n.show().addClass("on"))):(t.parents("tr").after('<tr class="history-detail" style="display:none;"><\/tr>'),$.post(setting.orderHistoryUrl,{sn:t.attr("sn")},function(i){var r,h,e,u,v,o,c;if(i.Success&&i.Data&&i.Data.category){var s=["收到新订单","订单处理中","订单确认","出货中","商品出库","包裹派送中","派送成功"],l=0,f="",a=!1;for(i.Data.category[2]&&i.Data.category[2].length>1&&(a=!0),r=0;r<s.length;r++){if(a&&s[r]=="订单处理中")continue;else if(!a&&s[r]=="订单确认")continue;f+='<li class="step">'+s[r];h=i.Data.category[r];h&&h.length>1&&(f+="<br>"+h,l=r,r<2&&(l+=1));f+="<\/li>"}f='<ol class="h-step'+l+'">'+f+"<\/ol>";e='<table class="h-list">';for(u in i.Data.history){e+='<tr><td colspan="2" class="h-day">'+u+"<\/td><\/tr>";v=0;for(o in i.Data.history[u])v++,c="",v==i.Data.history[u].length&&(c+="h-time-last"),(i.Data.history[u][o].state==5||i.Data.history[u][o].state==15)&&(c+=" red"),e+='<tr class="'+c+'"><td class="h-time">'+i.Data.history[u][o].time+'<\/td><td class="h-text"><img class="h-arrow" alt="" src="/images/arrow_right.gif" />'+i.Data.history[u][o].text+"<\/td><\/tr>"}e+="<\/table>";n=t.parents("tr").next(".history-detail");n.html('<td colspan="8">'+f+e+"<\/td>");$(".history-detail.on").hide().removeClass("on");$(".return-detail.on").hide().removeClass("on");n.show().addClass("on")}})),!1},getReturnTracking:function(){var t=$(this),n=t.parents("tr").next(".return-detail"),i;return n.find(".container:first").length>0?(i=n.hasClass("on"),i?n.hide().removeClass("on"):($(".history-detail.on").hide().removeClass("on"),$(".return-detail.on").hide().removeClass("on"),n.show().addClass("on"))):(t.parents("tr").after("<tr class='return-detail'><\/tr>"),$.post(setting.returnTrackingUrl,{rid:t.attr("rid")},function(i){var u,r,f;if(i.Success&&i.Data.length!=0){for(u="<td colspan='8'><div class='container'>",r=i.Data.length-1;r>=0;r--)r==2?u+="<div class='step-container "+(i.Data[r].Key==""?"package":"package-on")+"'  title='"+i.Data[r].Key+"'><div class='img-container'><\/div><span>"+i.Data[r].Value+"<\/span><br/><span "+(i.Data[1].Key==""?"style='color:red'":"")+">"+(i.Data[r].Key.length>17?i.Data[r].Key.substring(0,16)+"...":i.Data[r].Key)+"<\/span><\/div>":(r==3?u+=" <div class='step-container apply-on' >":r==1?u+="<div class='step-container "+(i.Data[r].Key==""?"arrival":"arrival-on")+"' >":r==0&&(u+="<div class='step-container "+(i.Data[r].Key==""?"finish":"finish-on")+"' >"),r==1&&i.Data[r].Key.search("｜")>-1?(f=i.Data[r].Key.split("｜"),u+="<div class='img-container'><\/div><span>"+i.Data[r].Value+"<\/span><br/><span>"+f[0]+"<\/span><br/><span>"+f[1]+"<\/span><\/div>"):u+="<div class='img-container'><\/div><span>"+i.Data[r].Value+"<\/span><br/><span>"+i.Data[r].Key+"<\/span><\/div>");u+="<\/div><\/td>";n=t.parents("tr").next(".return-detail");$(".history-detail.on").hide().removeClass("on");$(".return-detail.on").hide().removeClass("on");n.html(u).show().addClass("on")}})),!1},autoCollapse:function(n){var t=n.parent();t.prop("class").indexOf("on")==-1&&(t.parent().find("li.on").removeClass("on").find("div.content").slideUp(200),t.find("div.content").slideDown(200).parent().addClass("on"))}}})